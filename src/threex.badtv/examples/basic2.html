
<!DOCTYPE html>
<html lang="en">
<head>
	<title>Bad TV Shader for Three.js</title>
	<meta charset="utf-8">
	<style>
			body {
				background-color: #000;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				color: #fff;
				position: absolute;
				bottom: 20px;
				padding: 5px 20px;
				font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
				font-weight: 100;
				font-size: 18px;
				background-color: #000;
			}

			a{
				color: #DDD;				
			}
			
		</style>
</head>
<body>

	<div id="info">BadTV Effect for Three.js by @felixturner. Click to randomize.</div>
	<div id="container"></div>

	<script src="../../../vendor/three.js/build/three.min.js"></script>
	<script src='../../../vendor/three.js/examples/js/libs/dat.gui.min.js'></script>
	<script src="../../../vendor/three.js/examples/js/libs/stats.min.js"></script>
	<script src="../../../vendor/three.js/examples/js/postprocessing/EffectComposer.js"></script>
	<script src="../../../vendor/three.js/examples/js/postprocessing/RenderPass.js"></script>
	<script src="../../../vendor/three.js/examples/js/postprocessing/ShaderPass.js"></script>
	<script src="../../../vendor/three.js/examples/js/postprocessing/MaskPass.js"></script> 
	<script src="../../../vendor/three.js/examples/js/shaders/CopyShader.js"></script>
	<script src="../../../vendor/three.js/examples/js/ImprovedNoise.js"></script>
	<script src="../shaders/FilmShader.js"></script>
	<script src="../shaders/BadTVShader.js"></script>
	<script src="../shaders/RGBShiftShader.js"></script>
	<script src="../shaders/StaticShader.js"></script>

	<script src="../threex.badtvpasses.js"></script>
	<script src="../threex.badtvdatgui.js"></script>

	<script>

			//Bad TV Effect Test
			//using three.js r.52
			//by Felix Turner - www.airtight.cc - @felixturner

			var camera, scene, renderer;
			var video, videoTexture,videoMaterial;

			var composer;
			var shaderTime = 0;
			var badTVParams, badTVPass;		
			var staticParams, staticPass;		

			var rgbParams, rgbPass;	
			var filmParams, filmPass;	

			var renderPass, copyPass;
			
			var badTVPasses;

			var gui;

			var pnoise, globalParams;

			init();
			animate();

			function init() {

				camera = new THREE.PerspectiveCamera(55, 1080/ 720, 20, 3000);
				camera.position.z = 1000;
				scene = new THREE.Scene();

				//Load Video
				video = document.createElement( 'video' );
				video.loop = true;
				//video.muted = "muted";
				//video.volume = 0;
				video.src = "videos/fits.mp4";
				video.play();
				video.volume	= 0

				//Use webcam
				// video = document.createElement('video');
				// video.width = 320;
				// video.height = 240;
				// video.autoplay = true;
				// video.loop = true;
				// //Webcam video
				// window.URL = window.URL || window.webkitURL;
				// navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
				// //get webcam
				// navigator.getUserMedia({
				// 	video: true
				// }, function(stream) {
				// 	//on webcam enabled
				// 	video.src = window.URL.createObjectURL(stream);
				// 	// prompt.style.display = 'none';
				// 	// title.style.display = 'inline';
				// 	// container.style.display = 'inline';
				// 	// gui.domElement.style.display = 'inline';
				// }, function(error) {
				// 	prompt.innerHTML = 'Unable to capture WebCam. Please reload the page.';
				// });

				//init video texture
				videoTexture = new THREE.Texture( video );
				videoTexture.minFilter = THREE.LinearFilter;
				videoTexture.magFilter = THREE.LinearFilter;

				videoMaterial = new THREE.MeshBasicMaterial( {
					map: videoTexture
				} );


				//Add video plane
				var planeGeometry = new THREE.PlaneGeometry( 1080, 720,1,1 );
				var plane = new THREE.Mesh( planeGeometry, videoMaterial );
				scene.add( plane );
				plane.z = 0;
				plane.scale.x = plane.scale.y = 1.45;

				//add stats
				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );

				//init renderer
				renderer = new THREE.WebGLRenderer();
				renderer.setSize( 800, 600 );
				document.body.appendChild( renderer.domElement );

				//POST PROCESSING
				//Create Shader Passes
				renderPass = new THREE.RenderPass( scene, camera );

				// badTVPass = new THREE.ShaderPass( THREE.BadTVShader );
				// rgbPass = new THREE.ShaderPass( THREE.RGBShiftShader );
				// filmPass = new THREE.ShaderPass( THREE.FilmShader );
				// staticPass = new THREE.ShaderPass( THREE.StaticShader );

				badTVPasses	= new THREEx.BadTVPasses();
				badTVPass	= badTVPasses.badTVPass
				rgbPass		= badTVPasses.rgbPass
				filmPass	= badTVPasses.filmPass
				staticPass	= badTVPasses.staticPass


				copyPass = new THREE.ShaderPass( THREE.CopyShader );

				//set shader uniforms
				// filmPass.uniforms[ "grayscale" ].value = 0;
				

				//Init DAT GUI control panel
				badTVParams	= badTVPasses.badTVParams
				rgbParams	= badTVPasses.rgbParams
				filmParams	= badTVPasses.filmParams
				staticParams	= badTVPasses.staticParams

//////////////////////////////////////////////////////////////////////////////////
//		comment								//
//////////////////////////////////////////////////////////////////////////////////

				THREEx.addBadTVPasses2DatGui(badTVPasses, gui)

//////////////////////////////////////////////////////////////////////////////////
//		comment								//
//////////////////////////////////////////////////////////////////////////////////

				onToggleShaders();
				// onToggleMute();
				onParamsChange();

				window.addEventListener('resize', onResize, false);
				renderer.domElement.addEventListener('click', randomizeParams, false);

				onResize();

				randomizeParams();
			}

			function onParamsChange() {
				badTVPasses.onParamsChange()
			}


			function randomizeParams() {
				badTVPasses.randomizeParams()
				onParamsChange();
			}



			function onToggleMute(){
				video.volume  = badTVParams.mute ? 0 : 1;
			}

			function onToggleShaders(){

				//Add Shader Passes to Composer
				//order is important 
				composer = new THREE.EffectComposer( renderer);
				composer.addPass( renderPass );
				
				badTVPasses.addPassesTo(composer)

				composer.addPass( copyPass );
				copyPass.renderToScreen = true;
			}

			function animate() {

				shaderTime += 0.1;
				badTVPass.uniforms[ 'time' ].value =  shaderTime;
				filmPass.uniforms[ 'time' ].value =  shaderTime;
				staticPass.uniforms[ 'time' ].value =  shaderTime;

				if ( video.readyState === video.HAVE_ENOUGH_DATA ) {
					if ( videoTexture ) videoTexture.needsUpdate = true;
				}

				requestAnimationFrame( animate );
				composer.render( 0.1);
				stats.update();
			}

			function onResize() {
				renderer.setSize(window.innerWidth, window.innerHeight);
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
			}

			</script>
		</body>
		</html>
